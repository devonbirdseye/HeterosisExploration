---
title: "Final version of Leaf Heterosis proteomics for Paper"
output: github_document
---
#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(586)
```
```{r libraries}
library(matrixStats)
library(topGO)
library(ggplot2)
library(AnnotationDbi)
library(cowplot)
library(dplyr)
```

#Import data
```{r read csv}
df <- read.csv("data/Leaf paper-total proteome final 121319.csv", stringsAsFactors = F)
#make new column for gene accession without transcript id
df$Gene <- substr(df$Accession, start = 1, stop = 14)
df.withPolymorphic <- df
#Remove polymorphic proteins
df <- df[-(grep("only", df$Accession)),]
```

```{r T-test function}
ttestFun <- function(df, col1, col2){
  result <- NULL
  for(i in 1:(nrow(df))){
  v1 = (as.numeric(df[i, col1]))
  v2 = (as.numeric(df[i, col2]))
  t_test <- t.test(v1, v2, var.equal = TRUE)
  pval <- t_test$p.value
  result[i] <- pval
  }
  result
}
```

##Gamer GO

```{r read in gamer}
# Read in Maize GAMER GO dataset, which lists maize V4 accessions with all associated GO terms (Wimalanathan et al. 2018) downloaded from https://datacommons.cyverse.org/browse/iplant/home/shared/commons_repo/curated/Carolyn_Lawrence-Dill_maize-GAMER_maize.B73_RefGen_v4_Zm00001d.2_Oct_2017.r1/e.agg_data
GAMER <- read.delim("maize.B73.AGPv4.aggregate.gaf", sep = "\t", header = FALSE)
colnames(GAMER) <- c("db", "db_object_id", "db_object_symbol", "qualifier", "term_accession", "db_reference", "evidence_code", "with", "aspect", "db_object_name", "db_object_synonym", "db_object_type", "taxon", "date", "assigned_by", "annotation_extension", "gene_product_form_id")
gamer <- GAMER[-(1:2),]
gamer$Term <- Term(as.character(gamer$term_accession))
```


#Define topGO functions
```{r GOanalysisGOdata_Function}
## Build GOdata object
# EnrichedDF = AMP/BMP output or other subset dataframe of proteins of interest
# GamerCut = the dataframe created above
# ont = "BP", "MF", or "CC"
GOanalysisGodata <- function(EnrichedDF, GamerCut, ont, nodesize = 1){
  gene2GO_TissueCut <- split((as.character(GamerCut$term_accession)),GamerCut$db_object_id)
  gene2GOb_TissueCut <- gene2GO_TissueCut[-2]
  str(head(gene2GOb_TissueCut))
  geneNames_tissuecut <- names(gene2GOb_TissueCut)
  myInterestingGenes <- EnrichedDF$Gene
  geneList <- factor(as.integer(geneNames_tissuecut %in% myInterestingGenes))
  names(geneList) <- geneNames_tissuecut
  GOdata <- new("topGOdata", ontology = ont, allGenes = geneList, annot = annFUN.gene2GO, nodeSize=nodesize, gene2GO = gene2GOb_TissueCut)
  GOdata
}
```

```{r GOanalysisMap_Function}
## GO analysis function to generate map of GO terms
# Godata = Godata object (output of GoanalysisGodata function)
# pdfname = and desired output pdf name in quotes
GOanalysisMap <- function(GOdata, pdfname, signodes=5){
  resultFis <- runTest(GOdata, algorithm = "classic", statistic = "fisher")
  printGraph(GOdata, resultFis, firstSigNodes = signodes, fn.prefix = pdfname, useInfo = "all", pdfSW = TRUE)
}
```

```{r GOanalysisDF_Function}
## GO analysis function, same as above, except to generate dataframe summary of top 20 of GO terms instead of map
# Godata = Godata object (output of GoanalysisGodata function)
# pdfname = and desired output pdf name in quotes
GOanalysisDF <- function(GOdata){
resultFis <- runTest(GOdata, algorithm = "classic", statistic = "fisher")
test.statF <- new("classicCount", testStatistic = GOFisherTest, name = "Fisher test")
resultFisher <- getSigGroups(GOdata, test.statF)
test.statKS <- new("classicScore", testStatistic = GOKSTest, name = "KS tests")
resultKS <- getSigGroups(GOdata, test.statKS)
test.statRW <- new("weightCount", testStatistic = GOFisherTest, name = "Fisher test", sigRatio = "ratio")
resultWeight <- getSigGroups(GOdata, test.statRW)
DF <- GenTable(GOdata, classic = resultFis, KS = resultKS, weight = resultWeight, orderBy = "classic", ranksOf = "classic", topNodes = 20)
DF
}
```

#acs
##Format df
```{r format df}
#Subset
df.acs <- df[,c(1:18,89)]
#Remove missing genes
df.acs <- df.acs[!(df.acs$B73.acs.B73.r1==0),]
#Calculate averages of bio reps
df.acs$B73avg <- rowMeans(df.acs[,9:13])
df.acs$ACSavg <- rowMeans(df.acs[,14:18])
#calculate ratio
df.acs$ACS.B73 <- df.acs$ACSavg/df.acs$B73avg
#calculate t-test
df.acs$Sig <- ttestFun(df.acs, 9:13, 14:18)
#calculate log2(acs/b73)
df.acs$l2fc <- log2(df.acs$ACS.B73)
#Calculate standard deviation
df.acs$SD <- rowSds(as.matrix(df.acs[,14:18]))
#subset to 10% significantly above or below mid-parent
df.acs.amp <- df.acs[(df.acs$Sig<0.05)&(df.acs$ACS.B73>1.1),]
df.acs.bmp <- df.acs[(df.acs$Sig<0.05)&(df.acs$ACS.B73<0.9),]
```
##GO term enrichment
```{r trim gamer}
#Trim gamer to only those genes detected in our data, to use as background for enrichment
gamerCutACS <- gamer[(gamer$db_object_id %in% df.acs$Gene),]
```
```{r run GoanalysisGodata}
df.acs.amp_BP_GOdata <- GOanalysisGodata(df.acs.amp, gamerCutACS, "BP", nodesize = 5)
df.acs.amp_MF_GOdata <- GOanalysisGodata(df.acs.amp, gamerCutACS, "MF", nodesize = 5)
df.acs.amp_CC_GOdata <- GOanalysisGodata(df.acs.amp, gamerCutACS, "CC", nodesize = 5)

df.acs.bmp_BP_GOdata <- GOanalysisGodata(df.acs.bmp, gamerCutACS, "BP", nodesize = 5)
df.acs.bmp_MF_GOdata <- GOanalysisGodata(df.acs.bmp, gamerCutACS, "MF", nodesize = 5)
df.acs.bmp_CC_GOdata <- GOanalysisGodata(df.acs.bmp, gamerCutACS, "CC", nodesize = 5)
```
```{r run GoanalysisMap}
dir.create("GOmaps")
GOanalysisMap(df.acs.amp_BP_GOdata, "GOmaps/df.acs.amp_BP_GOdata")
GOanalysisMap(df.acs.amp_MF_GOdata, "GOmaps/df.acs.amp_MF_GOdata")
GOanalysisMap(df.acs.amp_CC_GOdata, "GOmaps/df.acs.amp_CC_GOdata")

GOanalysisMap(df.acs.bmp_BP_GOdata, "GOmaps/df.acs.bmp_BP_GOdata")
GOanalysisMap(df.acs.bmp_MF_GOdata, "GOmaps/df.acs.bmp_MF_GOdata")
GOanalysisMap(df.acs.bmp_CC_GOdata, "GOmaps/df.acs.bmp_CC_GOdata")
```
```{r run GoanalysisDF}
df.acs.amp_BP_GOdata.DF <- GOanalysisDF(df.acs.amp_BP_GOdata)
df.acs.amp_MF_GOdata.DF <- GOanalysisDF(df.acs.amp_MF_GOdata)
df.acs.amp_CC_GOdata.DF <- GOanalysisDF(df.acs.amp_CC_GOdata)

df.acs.bmp_BP_GOdata.DF <- GOanalysisDF(df.acs.bmp_BP_GOdata)
df.acs.bmp_MF_GOdata.DF <- GOanalysisDF(df.acs.bmp_MF_GOdata)
df.acs.bmp_CC_GOdata.DF <- GOanalysisDF(df.acs.bmp_CC_GOdata)
```

#Seedling Leaf - B73xMo17
##Format df
###AMP/BMP
```{r format df}
#Subset
df.SL <- df[,c(1:8,19:28,89)]
#Remove missing genes
df.SL <- df.SL[!(df.SL$SeedlingLeaf.B73.r1==0),]
#Calculate averages of bio reps
df.SL$B73avg <- rowMeans(df.SL[,10:12])
df.SL$Mo17avg <- rowMeans(df.SL[,13:15])
df.SL$HYBavg <- rowMeans(df.SL[,16:18])
df.SL$MPavg <- rowMeans(df.SL[,c(10:15)])
df.SL$MP.1 <- rowMeans(df.SL[,c(10,13)])
df.SL$MP.2 <- rowMeans(df.SL[,c(11,14)])
df.SL$MP.3 <- rowMeans(df.SL[,c(12,15)])
#calculate ratio
df.SL$HYB.MP <- df.SL$HYBavg/df.SL$MPavg
#calculate t-test
df.SL$Sig <- ttestFun(df.SL, 10:12, 24:26)
#calculate log2(hyb/MP)
df.SL$l2fc <- log2(df.SL$HYB.MP)
#subset to 10% significantly above or below mid-parent
df.SL.amp <- df.SL[(df.SL$Sig<0.05)&(df.SL$HYB.MP>1.1),]
df.SL.bmp <- df.SL[(df.SL$Sig<0.05)&(df.SL$HYB.MP<0.9),]
```
###MP + HP
```{r Subset to mid-parent proteins where parents are different}
#Copy data
df.SL.2 <- df.SL
#subset to proteins where parents are 10% different from each other
df.SL.2.b73hp <- df.SL.2[(df.SL.2$B73avg>1.1*(df.SL.2$Mo17avg)),]
df.SL.2.mo17hp <- df.SL.2[(df.SL.2$Mo17avg>1.1*(df.SL.2$B73avg)),]
#subset to proteins where hybrid is mid-parent
df.SL.2.b73hp.mp <- df.SL.2.b73hp[!(df.SL.2.b73hp$Accession%in%c(df.SL.amp$Accession, df.SL.bmp$Accession)),]
df.SL.2.mo17hp.mp <- df.SL.2.mo17hp[!(df.SL.2.mo17hp$Accession%in%c(df.SL.amp$Accession, df.SL.bmp$Accession)),]
#add column taking the ratio of the parents
df.SL.2.b73hp.mp$b73_mo17 <- df.SL.2.b73hp.mp$B73avg/df.SL.2.b73hp.mp$Mo17avg
df.SL.2.mo17hp.mp$mo17_b73 <- df.SL.2.mo17hp.mp$Mo17avg/df.SL.2.mo17hp.mp$B73avg
#subset to proteins with "translation" in the annotation
df.SL.2.b73hp.mp.translation <- df.SL.2.b73hp.mp[(grep("translation", df.SL.2.b73hp.mp$Protein)),]
df.SL.2.mo17hp.mp.translation <- df.SL.2.mo17hp.mp[(grep("translation", df.SL.2.mo17hp.mp$Protein)),]
#write csv
write.csv(df.SL.2.b73hp.mp, "df.SL.2.b73hp.mp.csv")
write.csv(df.SL.2.mo17hp.mp, "df.SL.2.mo17hp.mp.csv")
write.csv(df.SL.2.b73hp.mp.translation, "df.SL.2.b73hp.mp.translation.csv")
write.csv(df.SL.2.mo17hp.mp.translation, "df.SL.2.mo17hp.mp.translation.csv")
```
```{r Pie Chart}
df.SL.2<-data.frame("HP"=c("B73", "Mo17"), "MP"=c(nrow(df.SL.2.b73hp), nrow(df.SL.2.mo17hp)))

df.SL.2$HP<- c((paste0(df.SL.2[1,1], " - ", as.character(df.SL.2[1,2]))), (paste0(df.SL.2[2,1], " - ", as.character(df.SL.2[2,2]))))

df.SL.2 <- df.SL.2 %>%
  arrange(desc(HP)) %>%
  mutate(lab.ypos = cumsum(MP) - 0.5*MP)

df.SL.2.bar<- ggplot(df.SL.2, aes(x="", y=MP, fill=HP))+
geom_bar(width = 1, stat = "identity")
df.SL.2.pie <- df.SL.2.bar + coord_polar("y", start=0)+
  theme_void()+
  theme(axis.text=element_blank(), legend.position = "none")+
  geom_text(aes(y = lab.ypos, label = HP), color = "white", size=5)+
  ggtitle("High-parent for MP proteins")+
  theme(plot.title = element_text(hjust = .5))
df.SL.2.pie
ggsave("df.SL.2.pie.png", width = 4, height = 4)
```
###AMP/BMP + HP
```{r Subset to mid-parent proteins where parents are different}
#Copy data
df.SL.3 <- df.SL
#subset to proteins where parents are 10% different from each other
df.SL.3.b73hp <- df.SL.3[(df.SL.3$B73avg>1.1*(df.SL.3$Mo17avg)),]
df.SL.3.mo17hp <- df.SL.3[(df.SL.3$Mo17avg>1.1*(df.SL.3$B73avg)),]
#subset to proteins where hybrid is amp or bmp
df.SL.3.b73hp.amp <- df.SL.3.b73hp[(df.SL.3.b73hp$Accession%in%df.SL.amp$Accession),]
df.SL.3.b73hp.bmp <- df.SL.3.b73hp[(df.SL.3.b73hp$Accession%in%df.SL.bmp$Accession),]
df.SL.3.mo17hp.amp <- df.SL.3.mo17hp[(df.SL.3.mo17hp$Accession%in%df.SL.amp$Accession),]
df.SL.3.mo17hp.bmp <- df.SL.3.mo17hp[(df.SL.3.mo17hp$Accession%in%df.SL.bmp$Accession),]
```
```{r}
write.csv(df.SL.3.b73hp.amp, "df.SL.3.b73hp.amp.csv")
write.csv(df.SL.3.mo17hp.amp, "df.SL.3.mo17hp.amp.csv")
```

```{r pie chart - amp}
df.SL.3.amp<-data.frame("HP"=c("B73", "Mo17"), "AMP"=c(nrow(df.SL.3.b73hp.amp), nrow(df.SL.3.mo17hp.amp)))

df.SL.3.amp$HP<- c((paste0(df.SL.3.amp[1,1], " - ", as.character(df.SL.3.amp[1,2]))), (paste0(df.SL.3.amp[2,1], " - ", as.character(df.SL.3.amp[2,2]))))

df.SL.3.amp <- df.SL.3.amp %>%
  arrange(desc(HP)) %>%
  mutate(lab.ypos = cumsum(AMP) - 0.5*AMP)

df.SL.3.amp.bar<- ggplot(df.SL.3.amp, aes(x="", y=AMP, fill=HP))+
geom_bar(width = 1, stat = "identity")
df.SL.3.amp.pie <- df.SL.3.amp.bar + coord_polar("y", start=0)+
  theme_void()+
  theme(axis.text=element_blank(), legend.position = "none")+
  geom_text(aes(y = lab.ypos, label = HP), color = "white", size=5)+
  ggtitle("High-parent for 10% AMP proteins")+
  theme(plot.title = element_text(hjust = .5))
ggsave("df.SL.3.amp.pie.png", width = 4, height = 4)
```
```{r pie chart - bmp}
df.SL.3.bmp<-data.frame("LP"=c("Mo17", "B73"), "bmp"=c(nrow(df.SL.3.b73hp.bmp), nrow(df.SL.3.mo17hp.bmp)))

df.SL.3.bmp$HP<- c((paste0(df.SL.3.bmp[1,1], " - ", as.character(df.SL.3.bmp[1,2]))), (paste0(df.SL.3.bmp[2,1], " - ", as.character(df.SL.3.bmp[2,2]))))

df.SL.3.bmp <- df.SL.3.bmp %>%
  arrange(desc(HP)) %>%
  mutate(lab.ypos = cumsum(bmp) - 0.5*bmp)

df.SL.3.bmp.bar<- ggplot(df.SL.3.bmp, aes(x="", y=bmp, fill=HP))+
geom_bar(width = 1, stat = "identity")
df.SL.3.bmp.pie <- df.SL.3.bmp.bar + coord_polar("y", start=0)+
  theme_void()+
  theme(axis.text=element_blank(), legend.position = "none")+
  geom_text(aes(y = lab.ypos, label = HP), color = "white", size=5)+
  ggtitle("Low-parent for 10% BMP proteins")+
  theme(plot.title = element_text(hjust = .5))
ggsave("df.SL.3.bmp.pie.png", width = 4, height = 4)
```

##GO term enrichment
###AMP/BMP
```{r trim gamer}
#Trim gamer to only those genes detected in our data, to use as background for enrichment
gamerCutSL <- gamer[(gamer$db_object_id %in% df.SL$Gene),]
```
```{r run GoanalysisGodata for amp/bmp}
df.SL.amp_BP_GOdata <- GOanalysisGodata(df.SL.amp, gamerCutSL, "BP", nodesize = 5)
df.SL.amp_MF_GOdata <- GOanalysisGodata(df.SL.amp, gamerCutSL, "MF", nodesize = 5)
df.SL.amp_CC_GOdata <- GOanalysisGodata(df.SL.amp, gamerCutSL, "CC", nodesize = 5)

df.SL.bmp_BP_GOdata <- GOanalysisGodata(df.SL.bmp, gamerCutSL, "BP", nodesize = 5)
df.SL.bmp_MF_GOdata <- GOanalysisGodata(df.SL.bmp, gamerCutSL, "MF", nodesize = 5)
df.SL.bmp_CC_GOdata <- GOanalysisGodata(df.SL.bmp, gamerCutSL, "CC", nodesize = 5)
```
```{r run GoanalysisMap for amp/bmp}
dir.create("GOmaps")
GOanalysisMap(df.SL.amp_BP_GOdata, "GOmaps/df.SL.amp_BP_GOdata")
GOanalysisMap(df.SL.amp_MF_GOdata, "GOmaps/df.SL.amp_MF_GOdata")
GOanalysisMap(df.SL.amp_CC_GOdata, "GOmaps/df.SL.amp_CC_GOdata")

GOanalysisMap(df.SL.bmp_BP_GOdata, "GOmaps/df.SL.bmp_BP_GOdata")
GOanalysisMap(df.SL.bmp_MF_GOdata, "GOmaps/df.SL.bmp_MF_GOdata")
GOanalysisMap(df.SL.bmp_CC_GOdata, "GOmaps/df.SL.bmp_CC_GOdata")
```
```{r run GoanalysisDF for amp/bmp}
df.SL.amp_BP_GOdata.DF <- GOanalysisDF(df.SL.amp_BP_GOdata)
df.SL.amp_MF_GOdata.DF <- GOanalysisDF(df.SL.amp_MF_GOdata)
df.SL.amp_CC_GOdata.DF <- GOanalysisDF(df.SL.amp_CC_GOdata)

df.SL.bmp_BP_GOdata.DF <- GOanalysisDF(df.SL.bmp_BP_GOdata)
df.SL.bmp_MF_GOdata.DF <- GOanalysisDF(df.SL.bmp_MF_GOdata)
df.SL.bmp_CC_GOdata.DF <- GOanalysisDF(df.SL.bmp_CC_GOdata)
```
```{r view enrichment}
df.SL.bmp_CC_GOdata.DF
```

###MP + HP
```{r run GoanalysisGodata for hp+mp}
df.SL.2.b73hp.mp_BP_GOdata <- GOanalysisGodata(df.SL.2.b73hp.mp, gamerCutSL, "BP")
df.SL.2.b73hp.mp_CC_GOdata <- GOanalysisGodata(df.SL.2.b73hp.mp, gamerCutSL, "CC")
df.SL.2.b73hp.mp_MF_GOdata <- GOanalysisGodata(df.SL.2.b73hp.mp, gamerCutSL, "MF")

df.SL.2.mo17hp.mp_BP_GOdata <- GOanalysisGodata(df.SL.2.mo17hp.mp, gamerCutSL, "BP")
df.SL.2.mo17hp.mp_CC_GOdata <- GOanalysisGodata(df.SL.2.mo17hp.mp, gamerCutSL, "CC")
df.SL.2.mo17hp.mp_MF_GOdata <- GOanalysisGodata(df.SL.2.mo17hp.mp, gamerCutSL, "MF")
```
```{r run GoanalysisDF for hp+mp}
df.SL.2.b73hp.mp_BP_GOdata.DF <- GOanalysisDF(df.SL.2.b73hp.mp_BP_GOdata)
df.SL.2.b73hp.mp_CC_GOdata.DF <- GOanalysisDF(df.SL.2.b73hp.mp_CC_GOdata)
df.SL.2.b73hp.mp_MF_GOdata.DF <- GOanalysisDF(df.SL.2.b73hp.mp_MF_GOdata)

df.SL.2.mo17hp.mp_BP_GOdata.DF <- GOanalysisDF(df.SL.2.mo17hp.mp_BP_GOdata)
df.SL.2.mo17hp.mp_CC_GOdata.DF <- GOanalysisDF(df.SL.2.mo17hp.mp_CC_GOdata)
df.SL.2.mo17hp.mp_MF_GOdata.DF <- GOanalysisDF(df.SL.2.mo17hp.mp_MF_GOdata)
```
```{r view enrichment}
df.SL.2.mo17hp.mp_MF_GOdata.DF
```
###AMP/BMP + HP
```{r run GoanalysisGodata for amp/bmp+mp}
df.SL.3.b73hp.amp_BP_GOdata <- GOanalysisGodata(df.SL.3.b73hp.amp, gamerCutSL, "BP")
df.SL.3.b73hp.amp_CC_GOdata <- GOanalysisGodata(df.SL.3.b73hp.amp, gamerCutSL, "CC")
df.SL.3.b73hp.amp_MF_GOdata <- GOanalysisGodata(df.SL.3.b73hp.amp, gamerCutSL, "MF")

df.SL.3.mo17hp.amp_BP_GOdata <- GOanalysisGodata(df.SL.3.mo17hp.amp, gamerCutSL, "BP")
df.SL.3.mo17hp.amp_CC_GOdata <- GOanalysisGodata(df.SL.3.mo17hp.amp, gamerCutSL, "CC")
df.SL.3.mo17hp.amp_MF_GOdata <- GOanalysisGodata(df.SL.3.mo17hp.amp, gamerCutSL, "MF")

df.SL.3.b73hp.bmp_BP_GOdata <- GOanalysisGodata(df.SL.3.b73hp.bmp, gamerCutSL, "BP")
df.SL.3.b73hp.bmp_CC_GOdata <- GOanalysisGodata(df.SL.3.b73hp.bmp, gamerCutSL, "CC")
df.SL.3.b73hp.bmp_MF_GOdata <- GOanalysisGodata(df.SL.3.b73hp.bmp, gamerCutSL, "MF")

df.SL.3.mo17hp.bmp_BP_GOdata <- GOanalysisGodata(df.SL.3.mo17hp.bmp, gamerCutSL, "BP")
df.SL.3.mo17hp.bmp_CC_GOdata <- GOanalysisGodata(df.SL.3.mo17hp.bmp, gamerCutSL, "CC")
df.SL.3.mo17hp.bmp_MF_GOdata <- GOanalysisGodata(df.SL.3.mo17hp.bmp, gamerCutSL, "MF")
```
```{r run GoanalysisDF for amp/bmp+mp}
df.SL.3.b73hp.amp_BP_GOdata.DF <- GOanalysisDF(df.SL.3.b73hp.amp_BP_GOdata)
df.SL.3.b73hp.amp_CC_GOdata.DF <- GOanalysisDF(df.SL.3.b73hp.amp_CC_GOdata)
df.SL.3.b73hp.amp_MF_GOdata.DF <- GOanalysisDF(df.SL.3.b73hp.amp_MF_GOdata)

df.SL.3.mo17hp.amp_BP_GOdata.DF <- GOanalysisDF(df.SL.3.mo17hp.amp_BP_GOdata)
df.SL.3.mo17hp.amp_CC_GOdata.DF <- GOanalysisDF(df.SL.3.mo17hp.amp_CC_GOdata)
df.SL.3.mo17hp.amp_MF_GOdata.DF <- GOanalysisDF(df.SL.3.mo17hp.amp_MF_GOdata)

df.SL.3.b73hp.bmp_BP_GOdata.DF <- GOanalysisDF(df.SL.3.b73hp.bmp_BP_GOdata)
df.SL.3.b73hp.bmp_CC_GOdata.DF <- GOanalysisDF(df.SL.3.b73hp.bmp_CC_GOdata)
df.SL.3.b73hp.bmp_MF_GOdata.DF <- GOanalysisDF(df.SL.3.b73hp.bmp_MF_GOdata)

df.SL.3.mo17hp.bmp_BP_GOdata.DF <- GOanalysisDF(df.SL.3.mo17hp.bmp_BP_GOdata)
df.SL.3.mo17hp.bmp_CC_GOdata.DF <- GOanalysisDF(df.SL.3.mo17hp.bmp_CC_GOdata)
df.SL.3.mo17hp.bmp_MF_GOdata.DF <- GOanalysisDF(df.SL.3.mo17hp.bmp_MF_GOdata)
```
```{r view enrichment}
df.SL.3.b73hp.bmp_MF_GOdata.DF
```
#ACS and BxM enrichment overlap
```{r subset to proteins amp/bmp in both the mutant and hybrid}
df.SL.acs.amp <- df.SL.amp[(df.SL.amp$Accession%in%df.acs.amp$Accession),]
df.SL.acs.bmp <- df.SL.bmp[(df.SL.bmp$Accession%in%df.acs.bmp$Accession),]
df.SL.acs <- df.SL[(df.SL$Gene%in%df.acs$Gene),]
```
```{r trim gamer}
#Trim gamer to only those genes detected in our data, to use as background for enrichment
gamerCutSLacs <- gamer[(gamer$db_object_id %in% df.SL.acs$Gene),]
```
```{r run GOanalysisGodata on hyb+acs overlapping enrichment}
df.SL.acs.amp_BP_GOdata <- GOanalysisGodata(df.SL.acs.amp, gamerCutSLacs, "BP", nodesize = 5)
df.SL.acs.amp_MF_GOdata <- GOanalysisGodata(df.SL.acs.amp, gamerCutSLacs, "MF", nodesize = 5)
df.SL.acs.amp_CC_GOdata <- GOanalysisGodata(df.SL.acs.amp, gamerCutSLacs, "CC", nodesize = 5)

df.SL.acs.bmp_BP_GOdata <- GOanalysisGodata(df.SL.acs.bmp, gamerCutSLacs, "BP", nodesize = 5)
df.SL.acs.bmp_MF_GOdata <- GOanalysisGodata(df.SL.acs.bmp, gamerCutSLacs, "MF", nodesize = 5)
df.SL.acs.bmp_CC_GOdata <- GOanalysisGodata(df.SL.acs.bmp, gamerCutSLacs, "CC", nodesize = 5)
```
```{r run GOanalysisMap on hyb+acs overlapping enrichment}
dir.create("GOmaps")
GOanalysisMap(df.SL.acs.amp_BP_GOdata, "GOmaps/df.SL.acs.amp_BP_GOdata")
GOanalysisMap(df.SL.acs.amp_MF_GOdata, "GOmaps/df.SL.acs.amp_MF_GOdata")
GOanalysisMap(df.SL.acs.amp_CC_GOdata, "GOmaps/df.SL.acs.amp_CC_GOdata")

GOanalysisMap(df.SL.acs.bmp_BP_GOdata, "GOmaps/df.SL.acs.bmp_BP_GOdata")
GOanalysisMap(df.SL.acs.bmp_MF_GOdata, "GOmaps/df.SL.acs.bmp_MF_GOdata")
GOanalysisMap(df.SL.acs.bmp_CC_GOdata, "GOmaps/df.SL.acs.bmp_CC_GOdata")
```
```{r run GOanalysisDF on hyb+acs overlapping enrichment}
df.SL.acs.amp_BP_GOdata.DF <- GOanalysisDF(df.SL.acs.amp_BP_GOdata)
df.SL.acs.amp_MF_GOdata.DF <- GOanalysisDF(df.SL.acs.amp_MF_GOdata)
df.SL.acs.amp_CC_GOdata.DF <- GOanalysisDF(df.SL.acs.amp_CC_GOdata)

df.SL.acs.bmp_BP_GOdata.DF <- GOanalysisDF(df.SL.acs.bmp_BP_GOdata)
df.SL.acs.bmp_MF_GOdata.DF <- GOanalysisDF(df.SL.acs.bmp_MF_GOdata)
df.SL.acs.bmp_CC_GOdata.DF <- GOanalysisDF(df.SL.acs.bmp_CC_GOdata)
```
```{r view enrichment}
df.SL.acs.bmp_BP_GOdata.DF
```
#Merge acs and Seedling Leaf BxM data
```{r merge data for scatterplots}
df.acs.SL <- merge.data.frame(df.acs[,c(1:8,19,24:25)], df.SL[,c(6,c(27,29))], by="Accession", all = F, suffixes = c(".acs", ".BM"))
```

#Define GOIs
##godata
```{r}
godataBP <- GOanalysisGodata(df.SL, gamer, "BP")
godataCC <- GOanalysisGodata(df.SL, gamer, "CC")
```
```{r}
SelectGOgenes <- function(GOdata, GOterm){
 df <- data.frame("Gene"=(topGO::genesInTerm(GOdata, GOterm)))
colnames(df)="Gene"
as.character(df$Gene)
}
```

##Photosynthesis
```{r}
Photosynthesis <- SelectGOgenes(godataBP, "GO:0015979")

#Add CornCyc annotated PhANGs
#accessed from https://corncyc-b73-v4.maizegdb.org/ on 1/4/2020
cornCyc<-as.data.frame(readr::read_csv(file = "cornCycGeneLists01042020.csv",
                         col_names = TRUE
                         ))
cornCyc.PHANG <- unique(c(cornCyc$`Gene Accession`[(cornCyc$Pathway=="Oxygenic_Photosynthesis_SuperPath")], cornCyc$`Gene Accession`[(cornCyc$Pathway=="Light_Rxn")]))
cornCyc.PHANG <- df.SL$Gene[(df.SL$Gene%in%cornCyc.PHANG)]
Photosynthesis <- unique(c(Photosynthesis, cornCyc.PHANG))

thylakoid <- SelectGOgenes(godataCC, "GO:0009579")

lightrxn <- SelectGOgenes(godataBP, "GO:0019684")
lightrxn <- unique(c(lightrxn, cornCyc$`Gene Accession`[(cornCyc$Pathway=="Light_Rxn")]))

darkrxn <- SelectGOgenes(godataBP, "GO:0019685")
cornCyc.CC <- cornCyc$`Gene Accession`[(cornCyc$Pathway=="Calvin_Cycle")]
darkrxn <- unique(c(darkrxn, cornCyc.CC))

Photosynthesis.other <- Photosynthesis[!Photosynthesis%in%c(darkrxn,lightrxn,thylakoid)]
```




##Plastid-encoded
```{r}
#Plastid-encoded proteins
Pt<-df.SL[grep("v4:Pt", df.SL$Protein),]
#define list of plastid-encoded photosynthesis-associated genes
PtPS <- Pt[-grep("rps|rpo|rpl|orf", Pt$Protein),]
#Plastid encoded ribosomal proteins (EnsemblPlants Annotation)
#get subset of Pt encoded genes annotated as ribosomal proteins
Pt.ribo <- Pt[grep("rps|rpl", Pt$Protein),]
#Plastid encoded RNA polymerases (EnsemblPlants Annotation)
Pt.rpo <- Pt[grep("rpo", Pt$Protein),]
#re-define to gene vector
Pt <- Pt$Gene
PtPS <- PtPS$Gene
Pt.ribo <- Pt.ribo$Gene
Pt.rpo <- Pt.rpo$Gene
#Define "other" as everything left
Pt.other <- Pt[!(Pt%in%c(Pt.ribo, PtPS, Pt.rpo))]
```

##Nuclear-encoded plastid ribosome
```{r}
#Nuclear encoded plastid ribosomal proteins (GO GAMER and EnsemblPlants Annotation)
Nuc.PtRibo <- SelectGOgenes(godataCC, "GO:0009547")
#Add proteins annotated as "ribosom" and "plastid/chloroplast" to the nuclear-encoded plastid-localized list
ribosom <- df.SL[(grep("ribosom", df.SL$Protein)),]
ribosom.pt <- ribosom[(grep("plastid|Plastid|Chloropl|chloropl", ribosom$Protein)),]
#remove plastid-encoded 
ribosom.pt <- ribosom.pt[-grep("NP_04",ribosom.pt$Protein),]
Nuc.PtRibo <- unique(c(Nuc.PtRibo,ribosom.pt$Gene))
#Check that there are no missing prokaryotic ribosomal proteins with plastid localization
ProkRibo <- df.SL[(grep("30S|60S", df.SL$Protein)),]
ProkRiboNotPt <- ProkRibo[!(ProkRibo$Gene%in%Nuc.PtRibo),]
GOplastid <- SelectGOgenes(godataCC, "GO:0009536")
ProkRiboNotPt.plastid <- ProkRiboNotPt[(ProkRiboNotPt$Gene%in%GOplastid),]
Nuc.PtRibo <- unique(c(Nuc.PtRibo, ProkRiboNotPt.plastid$Gene))
```

##Eukaryotic ribosome
```{r}
#Eukaryotic ribosomal proteins (EnsemblPlants Annotation)
eukRibo<-df.SL[(grep("40S|60S", df.SL$Protein)),]
#remove the mitochondrial ones
eukRibo<- eukRibo$Gene[-(grep("mito|Mito", eukRibo$Protein))]
```

##Etyhlene
```{r 7}
MAT <- cornCyc$`Gene Accession`[(cornCyc$`Enzymatic activity`=="methionine adenosyltransferase")]
ACS <- cornCyc$`Gene Accession`[(cornCyc$`Enzymatic activity`=="1-aminocyclopropane-1-carboxylate synthase")]
ACO <- cornCyc$`Gene Accession`[(cornCyc$`Enzymatic activity`=="1-aminocyclopropane-1-carboxylate oxidase")]
EtBio <- c(MAT,ACS,ACO)
EtBio <- df.SL$Gene[(df.SL$v4_gene_model%in%EtBio)]
```
```{r 8}
ResponseToEt <- SelectGOgenes(godataBP, "GO:0009723")
```


#Scatterplot - Photosynthesis
##Make GOI description column
```{r define categories}
df.acs.SL.scat1 <- df.acs.SL
df.acs.SL.scat1$Category <- "Other"
df.acs.SL.scat1$Order <- 1
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% Photosynthesis.other),"Category"] <- "Photosynthesis other"
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% Photosynthesis.other),"Order"] <- 2
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% thylakoid),"Category"] <- "thylakoid"
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% thylakoid),"Order"] <- 3
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% lightrxn),"Category"] <- "light reactions"
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% lightrxn),"Order"] <- 4
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% darkrxn),"Category"] <- "dark reactions"
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% darkrxn),"Order"] <- 5
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% PtPS),"Category"] <- "Plastid-encoded photosynthesis"
df.acs.SL.scat1[(df.acs.SL.scat1$Gene %in% PtPS),"Order"] <- 6
#Re-order
df.acs.SL.scat1 <- df.acs.SL.scat1[(order(df.acs.SL.scat1$Order)),]
```

##Set limits for plot
```{r}
df.acs.SL.scat1.lims <- df.acs.SL.scat1

df.acs.SL.scat1.lims$l2fc.acs[df.acs.SL.scat1.lims$l2fc.acs > 1.0] = 1.0
df.acs.SL.scat1.lims$l2fc.acs[df.acs.SL.scat1.lims$l2fc.acs < -1.0] = -1.0

df.acs.SL.scat1.lims$l2fc.BM[df.acs.SL.scat1.lims$l2fc.BM > 1.0] = 1.0
df.acs.SL.scat1.lims$l2fc.BM[df.acs.SL.scat1.lims$l2fc.BM < -1.0] = -1.0
```
##Make scatterplot
```{r}
fig.photosynthesis <- ggplot(df.acs.SL.scat1.lims, mapping=aes(x=l2fc.BM, y=l2fc.acs, color=Category))+
  geom_point(size=.8)+
  scale_color_manual(values=c("Other"="grey85","light reactions"="#0bb003", "dark reactions"="#0235de", "thylakoid"="#f5a800", "Photosynthesis other"="#eb0003", "Plastid-encoded photosynthesis"="#e600f5"), name="Protein Category")+
    theme_classic()+
    xlim(c(-1,1))+
    ylim(c(-1,1))+
    geom_vline(xintercept=0, linetype="dashed", color = "gray50")+
    geom_hline(yintercept=0, linetype="dashed", color = "gray50")+
    #geom_abline(intercept =0 , slope = 1, linetype="dashed", color="gray50")+
    theme(axis.text=element_text(size=10),
              legend.position="bottom", legend.title = element_text(size=6), legend.text = element_text(size=8))+
    guides(color=guide_legend(nrow=3,byrow=TRUE))+
    xlab("log2 hyb/MP protein abundance")+
    ylab("log2 acs/B73 protein abundance")+
    coord_fixed(expand = F)

fig.photosynthesis
```
##Add density curves
```{r}
#add density curves
#add marginal density plots and resave
    densityplotX<-axis_canvas(fig.photosynthesis, axis="x")+
      geom_density(aes(df.acs.SL.scat1.lims[,"l2fc.BM"], color=df.acs.SL.scat1.lims[,"Category"]), df.acs.SL.scat1.lims, size=0.7)+
      scale_color_manual(values=c("Other"="grey85","light reactions"="#0bb003", "dark reactions"="#0235de", "thylakoid"="#f5a800", "Photosynthesis other"="#eb0003", "Plastid-encoded photosynthesis"="#e600f5"))+
      geom_vline(xintercept=0, linetype="dashed", color = "gray50")+
      theme_void()
    #set up marginal density plot Y axis
    densityplotY<-axis_canvas(fig.photosynthesis, axis="y", coord_flip = T)+
      geom_density(aes(df.acs.SL.scat1.lims[,"l2fc.acs"], color=df.acs.SL.scat1.lims[,"Category"]), df.acs.SL.scat1.lims, size=0.7)+
      scale_color_manual(values=c("Other"="grey85","light reactions"="#0bb003", "dark reactions"="#0235de", "thylakoid"="#f5a800", "Photosynthesis other"="#eb0003", "Plastid-encoded photosynthesis"="#e600f5"))+
      geom_vline(xintercept=0, linetype="dashed", color = "gray50")+
      theme_void()+
      coord_flip()
    #put two plots together
    q <- insert_xaxis_grob(fig.photosynthesis, densityplotX, grid::unit(0.275, "null"), position = "top")
    q <- insert_yaxis_grob(q, densityplotY, grid::unit(0.275, "null"), position = "right")
    #save
  ggsave(plot=q, filename = "FigPhotosynthesis.tiff",
        device="tiff", dpi=300, width=4.5, height=4.5, compression = "lzw")
```
#Scatterplot - Ribosome
##Make GOI description column
```{r define categories}
df.acs.SL.scat2 <- df.acs.SL
df.acs.SL.scat2$Category <- "Other"
df.acs.SL.scat2$Order <- 1
df.acs.SL.scat2[(df.acs.SL.scat2$Gene %in% eukRibo),"Category"] <- "Eukaryotic ribsome"
df.acs.SL.scat2[(df.acs.SL.scat2$Gene %in% eukRibo),"Order"] <- 2
df.acs.SL.scat2[(df.acs.SL.scat2$Gene %in% Nuc.PtRibo),"Category"] <- "Nuclear-encoded plastid ribosome"
df.acs.SL.scat2[(df.acs.SL.scat2$Gene %in% Nuc.PtRibo),"Order"] <- 3
df.acs.SL.scat2[(df.acs.SL.scat2$Gene %in% Pt.ribo),"Category"] <- "Plastid-encoded ribosome"
df.acs.SL.scat2[(df.acs.SL.scat2$Gene %in% Pt.ribo),"Order"] <- 4
#Re-order
df.acs.SL.scat2 <- df.acs.SL.scat2[(order(df.acs.SL.scat2$Order)),]
```
##Set limits for plot
```{r}
df.acs.SL.scat2.lims <- df.acs.SL.scat2

df.acs.SL.scat2.lims$l2fc.acs[df.acs.SL.scat2.lims$l2fc.acs > 1.0] = 1.0
df.acs.SL.scat2.lims$l2fc.acs[df.acs.SL.scat2.lims$l2fc.acs < -1.0] = -1.0

df.acs.SL.scat2.lims$l2fc.BM[df.acs.SL.scat2.lims$l2fc.BM > 1.0] = 1.0
df.acs.SL.scat2.lims$l2fc.BM[df.acs.SL.scat2.lims$l2fc.BM < -1.0] = -1.0
```
##Make scatterplot
```{r}
fig.ribosome <- ggplot(df.acs.SL.scat2.lims, mapping=aes(x=l2fc.BM, y=l2fc.acs, color=Category))+
  geom_point(size=.8)+
  scale_color_manual(values=c("Other"="grey85","Eukaryotic ribsome"="red", "Nuclear-encoded plastid ribosome"="#0235de", "Plastid-encoded ribosome"="#0bb003"), name="Protein Category")+
    theme_classic()+
    xlim(c(-1,1))+
    ylim(c(-1,1))+
    geom_vline(xintercept=0, linetype="dashed", color = "gray50")+
    geom_hline(yintercept=0, linetype="dashed", color = "gray50")+
    #geom_abline(intercept =0 , slope = 1, linetype="dashed", color="gray50")+
    theme(axis.text=element_text(size=10),
              legend.position="bottom", legend.title = element_text(size=6), legend.text = element_text(size=8))+
    guides(color=guide_legend(nrow=2,byrow=TRUE))+
    xlab("log2 hyb/MP protein abundance")+
    ylab("log2 acs/B73 protein abundance")+
    coord_fixed(expand = F)

fig.ribosome
```
##Add density curves
```{r}
#add density curves
#add marginal density plots and resave
    densityplotX<-axis_canvas(fig.ribosome, axis="x")+
      geom_density(aes(df.acs.SL.scat2.lims[,"l2fc.BM"], color=df.acs.SL.scat2.lims[,"Category"]), df.acs.SL.scat2.lims, size=0.7)+
      scale_color_manual(values=c("Other"="grey85","Eukaryotic ribsome"="red", "Nuclear-encoded plastid ribosome"="#0235de", "Plastid-encoded ribosome"="#0bb003"))+
      geom_vline(xintercept=0, linetype="dashed", color = "gray50")+
      theme_void()
    #set up marginal density plot Y axis
    densityplotY<-axis_canvas(fig.ribosome, axis="y", coord_flip = T)+
      geom_density(aes(df.acs.SL.scat2.lims[,"l2fc.acs"], color=df.acs.SL.scat2.lims[,"Category"]), df.acs.SL.scat2.lims, size=0.7)+
      scale_color_manual(values=c("Other"="grey85","Eukaryotic ribsome"="red", "Nuclear-encoded plastid ribosome"="#0235de", "Plastid-encoded ribosome"="#0bb003"))+
      geom_vline(xintercept=0, linetype="dashed", color = "gray50")+
      theme_void()+
      coord_flip()
    #put two plots together
    q <- insert_xaxis_grob(fig.ribosome, densityplotX, grid::unit(0.275, "null"), position = "top")
    q <- insert_yaxis_grob(q, densityplotY, grid::unit(0.275, "null"), position = "right")
    #save
  ggsave(plot=q, filename = "FigRibosome.tiff",
        device="tiff", dpi=300, width=4.5, height=4.5, compression = "lzw")
```